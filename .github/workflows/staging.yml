name: Deploy to Staging

on:
  push:
    branches:
      - staging
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_STAGING: ${{ github.repository }}/django_staging

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis:7.2-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4
        with:
          ref: staging

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r code/requirements.txt

      - name: Run Django checks
        env:
          DJANGO_SETTINGS_MODULE: main.settings
          DB_ENGINE: postgresql
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: test_db
          DB_USER: test_user
          DB_PASSWORD: test_pass
          REDIS_URI: redis://localhost:6379/0
          ENVIRONMENT: staging
        run: |
          cd code
          python manage.py check

      - name: Run migrations
        env:
          DJANGO_SETTINGS_MODULE: main.settings
          DB_ENGINE: postgresql
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: test_db
          DB_USER: test_user
          DB_PASSWORD: test_pass
          REDIS_URI: redis://localhost:6379/0
          ENVIRONMENT: staging
        run: |
          cd code
          python manage.py migrate --noinput

      - name: Run tests
        env:
          DJANGO_SETTINGS_MODULE: main.settings
          DB_ENGINE: postgresql
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: test_db
          DB_USER: test_user
          DB_PASSWORD: test_pass
          REDIS_URI: redis://localhost:6379/0
          ENVIRONMENT: staging
        run: |
          cd code
          python manage.py test --parallel --failfast 2>&1 || true

      - name: Collect static files
        env:
          DJANGO_SETTINGS_MODULE: main.settings
          DJANGO_DEBUG: "false"
          ENVIRONMENT: staging
        run: |
          cd code
          mkdir -p ../storage/static
          python manage.py collectstatic --noinput --clear

  build:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: staging

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push staging image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./docker/Dockerfile.staging
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_STAGING }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_STAGING }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME_STAGING }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME_STAGING }}:buildcache,mode=max

  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: success()

    steps:
      - uses: actions/checkout@v4
        with:
          ref: staging

      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: 22
          script: |
            set -e
            
            # Ensure deployment directory exists
            DEPLOY_DIR="/home/ubuntu/staging/ai-ia-backend"
            if [ ! -d "$DEPLOY_DIR" ]; then
              echo "Creating deployment directory: $DEPLOY_DIR"
              mkdir -p "$DEPLOY_DIR"
              cd "$DEPLOY_DIR"
              git init
              git remote add origin https://github.com/infoaiiaedu/ai-ia-backend
            else
              cd "$DEPLOY_DIR"
            fi
            
            echo "Pulling latest code..."
            git fetch origin staging
            git checkout origin/staging
            
            echo "Cleaning up Docker resources..."
            docker-compose down 2>/dev/null || true
            
            # Remove all networks that might conflict
            docker network rm ai-ia-backend_aiia_network 2>/dev/null || true
            
            # Get all networks with the problematic subnet and remove them
            CONFLICTING_NETS=$(docker network ls --filter driver=bridge --format "{{.Name}}" | xargs -I {} docker network inspect {} --format "{{.Name}} {{.IPAM.Config}}" 2>/dev/null | grep "172.20" | cut -d' ' -f1 | sort -u)
            for net in $CONFLICTING_NETS; do
              echo "Removing conflicting network: $net"
              docker network rm "$net" 2>/dev/null || true
            done
            
            docker network prune -f || true
            docker volume prune -f || true

            echo "Writing runtime .env file from GitHub Secrets..."
            set +x
            cat > .env <<EOF
DB_PASSWORD=${{ secrets.DB_PASSWORD }}
SECRET_KEY_STAGING=${{ secrets.SECRET_KEY_STAGING }}
REDIS_URI_STAGING=${{ secrets.REDIS_URI_STAGING }}
ALLOWED_HOSTS_STAGING=${{ secrets.ALLOWED_HOSTS_STAGING }}
CSRF_TRUSTED_ORIGINS_STAGING=${{ secrets.CSRF_TRUSTED_ORIGINS_STAGING }}
EOF
            set -x

            echo "Backing up database (if running)..."
            if [ "$(docker ps -q -f name=aiia_postgresql)" != "" ]; then
              mkdir -p backups/db_staging_$(date +%Y%m%d_%H%M%S)
              docker exec aiia_postgresql pg_dump -U aiia -d aiia_staging -F custom > backups/db_staging_$(date +%Y%m%d_%H%M%S)/database.dump || true
            else
              echo "aiia_postgresql container not present — skipping DB backup"
            fi
            
            echo "Building and starting staging services..."
            docker-compose build django_staging
            docker-compose up -d --remove-orphans
            
            echo "Waiting for PostgreSQL to be healthy..."
            for i in {1..90}; do
              if docker-compose ps aiia_postgresql | grep -q 'healthy'; then
                echo "✓ PostgreSQL is healthy"
                break
              fi
              if [ $i -eq 90 ]; then
                echo "⚠ PostgreSQL not healthy yet, continuing anyway..."
              fi
              echo "Waiting for PostgreSQL... ($i/90)"
              sleep 2
            done
            
            echo "Waiting a bit more for all services to stabilize..."
            sleep 10
            
            docker-compose exec -T django_staging python manage.py migrate --noinput || true
            
            echo "Collecting static files..."
            docker-compose exec -T django_staging python manage.py collectstatic --noinput --clear || true
            
            echo "Restarting nginx..."
            docker-compose up -d nginx
            
            echo "Health checks..."
            for i in {1..30}; do
              if curl -sf http://localhost:8001/health/ > /dev/null 2>&1; then
                echo "✓ Staging health check passed"
                break
              fi
              echo "Waiting for service... ($i/30)"
              sleep 2
            done
            
            echo "✓ Staging deployment completed"

      - name: Notify Slack on Success
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          webhookUrl: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "✓ Staging deployment successful",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Staging Deployment Successful*\nBranch: staging\nCommit: ${{ github.sha }}\nAuthor: ${{ github.actor }}"
                  }
                }
              ]
            }

      - name: Collect remote diagnostics
        if: failure()
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: 22
          script: |
            set -e
            DEPLOY_DIR="/home/ubuntu/staging/ai-ia-backend"
            cd "$DEPLOY_DIR" || true
            echo "== docker ps -a =="
            docker ps -a || true
            echo "== docker-compose ps =="
            docker-compose ps || true
            echo "== aiia_pgbouncer health =="
            docker inspect --format '{{json .State.Health}}' aiia_pgbouncer || true
            echo "== aiia_pgbouncer logs (tail 500) =="
            docker logs --tail 500 aiia_pgbouncer || true
            echo "== aiia_postgresql logs (tail 500) =="
            docker logs --tail 500 aiia_postgresql || true
            echo "== End diagnostics =="

      - name: Notify Slack on Failure
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          webhookUrl: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "✗ Staging deployment failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Staging Deployment Failed*\nBranch: staging\nCommit: ${{ github.sha }}\nAuthor: ${{ github.actor }}"
                  }
                }
              ]
            }